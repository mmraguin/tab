<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>tala.</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap">
<style>
:root {
  --bg:#0b0b0d;--surface:#141416;--surface2:#1e1e22;--surface3:#28282e;
  --border:#2a2a30;--border2:#363640;
  --accent:#2a9d9f;--accent-dim:rgba(42,157,159,0.10);--accent-border:rgba(42,157,159,0.25);
  --text:#ededf0;--text2:#9898a6;--muted:#60606e;
  --income:#4ade80;--income-dim:rgba(74,222,128,0.08);--income-border:rgba(74,222,128,0.20);
  --expense:#ff5c5c;--expense-dim:rgba(255,92,92,0.08);--expense-border:rgba(255,92,92,0.20);
  --danger:#e63946;--transfer:#b8a9e0;
  --warn:#c8922a;--warn-dim:rgba(200,146,42,0.08);--warn-border:rgba(200,146,42,0.25);
  --tab-h:60px;--safe-b:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;font-variant-numeric:tabular-nums;background:var(--bg);color:var(--text);display:flex;justify-content:center}
body::after{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:.025;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E")}
.app{width:100%;max-width:430px;height:100%;display:flex;flex-direction:column;overflow:hidden}
.hdr{flex-shrink:0;padding:13px 14px 11px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);background:rgba(11,11,13,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:10}
.wordmark{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.03em}
.wordmark em{color:var(--accent);font-style:normal}
.hdr-r{display:flex;gap:6px;align-items:center}
.mnav{display:flex;align-items:center;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:4px 6px}
.marrow{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1;padding:0 4px;transition:color .15s}
.marrow:hover{color:var(--accent)}
.mlabel{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--text);min-width:68px;text-align:center;letter-spacing:.04em}
.hbtn{width:32px;height:32px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .15s;user-select:none}
.hbtn:active{transform:scale(.9);color:var(--accent)}
.pw{flex:1;overflow:hidden;position:relative}
.pages{display:flex;width:600%;height:100%;transition:transform .32s cubic-bezier(.22,1,.36,1)}
.page{width:16.6667%;height:100%;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;flex-shrink:0}
.page::-webkit-scrollbar{display:none}
.pi{padding:12px 12px 28px;display:flex;flex-direction:column;gap:10px}
.tabbar{flex-shrink:0;height:calc(var(--tab-h) + var(--safe-b));padding-bottom:var(--safe-b);border-top:1px solid var(--border);background:rgba(20,20,22,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);display:flex;z-index:10}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;color:var(--muted);padding-top:4px;transition:color .15s;user-select:none}
.tab:active{transform:scale(.88)}
.tab.active{color:var(--accent)}
.ti{width:20px;height:20px;position:relative}
.ti svg{width:100%;height:100%;stroke:currentColor;fill:none;stroke-width:1.75;stroke-linecap:round;stroke-linejoin:round}
.tlabel{font-size:9px;font-weight:600;letter-spacing:.01em}
.tbadge{position:absolute;top:-3px;right:-7px;background:var(--expense);color:#fff;font-family:'DM Mono',monospace;font-size:8px;font-weight:500;border-radius:10px;padding:1px 4px;min-width:14px;text-align:center}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:48px 20px;display:flex;flex-direction:column;align-items:center;gap:14px}
.pr{width:40px;height:40px;position:relative;display:flex;align-items:center;justify-content:center}
.pr::before,.pr::after{content:'';position:absolute;border:1.5px solid var(--accent);border-radius:50%;animation:pout 1.4s ease-out infinite}
.pr::after{animation-delay:.6s}
@keyframes pout{0%{width:10px;height:10px;opacity:1}100%{width:40px;height:40px;opacity:0}}
.pdot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
.stext{font-size:13px;color:var(--text2);text-align:center;line-height:1.5}
.etitle{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--danger)}
.btn-retry{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 24px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.hero{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px 20px;position:relative;overflow:hidden}
.hglow{position:absolute;top:-60px;left:-40px;width:220px;height:220px;border-radius:50%;pointer-events:none}
.hglow.pos{background:radial-gradient(circle,rgba(74,222,128,.12) 0%,transparent 70%)}
.hglow.warn{background:radial-gradient(circle,rgba(200,146,42,.12) 0%,transparent 70%)}
.hglow.neg{background:radial-gradient(circle,rgba(255,92,92,.12) 0%,transparent 70%)}
.hi{position:relative;z-index:1}
.hmlbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.hamt{font-variant-numeric:tabular-nums;font-size:36px;font-weight:700;letter-spacing:-.025em;line-height:1}
.hamt.pos{color:var(--income)}.hamt.warn{color:var(--warn)}.hamt.neg{color:var(--expense)}
.ts{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:center;padding:4px 0 8px}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="wordmark">tala<em>.</em></div>
    <div class="hdr-r">
      <div class="mnav">
        <button class="marrow" onclick="changeMonth(-1)">‹</button>
        <div class="mlabel" id="mlabel">---</div>
        <button class="marrow" onclick="changeMonth(1)">›</button>
      </div>
      <div class="hbtn" id="refbtn" onclick="loadData()">↻</div>
    </div>
  </div>
  <div class="pw" id="pw">
    <div class="pages" id="pages">
      <div class="page" id="p0"><div class="pi" id="hc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p1"><div class="pi" id="pc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p2"><div class="pi" id="sc2"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p3"><div class="pi" id="ac"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p4"><div class="pi" id="gc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
      <div class="page" id="p5"><div class="pi" id="rc"><div class="sc"><div class="pr"><div class="pdot"></div></div><div class="stext">Loading...</div></div></div></div>
    </div>
  </div>
  <div class="tabbar">
    <div class="tab active" data-tab="0" onclick="switchTab(0)">
      <div class="ti"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
      <div class="tlabel">Home</div>
    </div>
    <div class="tab" data-tab="1" onclick="switchTab(1)">
      <div class="ti"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
      <div class="tlabel">Plan</div>
    </div>
    <div class="tab" data-tab="2" onclick="switchTab(2)">
      <div class="ti"><svg viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></div>
      <div class="tlabel">Spend</div>
    </div>
    <div class="tab" data-tab="3" onclick="switchTab(3)">
      <div class="ti"><svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg></div>
      <div class="tlabel">Accounts</div>
    </div>
    <div class="tab" data-tab="4" onclick="switchTab(4)">
      <div class="ti"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M12 12v10M12 22l4-4M12 22l-4-4"/></svg></div>
      <div class="tlabel">Goals</div>
    </div>
    <div class="tab" data-tab="5" onclick="switchTab(5)">
      <div class="ti"><svg viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M18 17l-3-3-4 4-4-4-4 4"/></svg></div>
      <div class="tlabel">Reports</div>
    </div>
  </div>
</div>
<script>
var WEBHOOK='https://script.google.com/macros/s/AKfycbxArmvsbhZIthFv1qqy2cEl5pRRZin2-V-RFdpbuOh--1iESw4m1E8NXo3XtaKqpu-nng/exec';
var ACCOUNTS=['BDO','BPI','Cash','GCash','Maribank','Maya','UnionBank','UnionBank Credit'];
var MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];

var viewMonth=new Date();viewMonth.setDate(1);
var curTab=0,rawB=null,rawA=null,rawS=null,parsed=null,lastUp=null;

function parseDate(v){if(!v)return null;if(v instanceof Date)return v;var s=String(v).trim();var m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(m)return new Date(+m[3],+m[1]-1,+m[2]);return new Date(v)}
function pn(v){return parseFloat(String(v||'0').replace(/[^0-9.\-]/g,''))||0}
function peso(n){return '₱'+Math.abs(n).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2})}
function sh(n){var a=Math.abs(n);if(a>=1e6)return '₱'+(a/1e6).toFixed(1)+'M';if(a>=1e3)return '₱'+(a/1e3).toFixed(1)+'k';return '₱'+a.toFixed(0)}

function setML(){document.getElementById('mlabel').textContent=MONTHS[viewMonth.getMonth()].slice(0,3).toUpperCase()+' '+viewMonth.getFullYear()}
function changeMonth(d){viewMonth=new Date(viewMonth.getFullYear(),viewMonth.getMonth()+d,1);setML();if(rawB){parsed=parseAll();renderCur()}}
function switchTab(idx){curTab=idx;document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',+t.dataset.tab===idx)});document.getElementById('pages').style.transform='translateX(-'+((idx/6)*100)+'%)';if(parsed)renderCur()}
function renderCur(){if(curTab===0)renderHome();else if(curTab===1)renderPlan();else if(curTab===2)renderSpend();else if(curTab===3)renderAccounts();else if(curTab===4)renderGoals();else if(curTab===5)renderReports()}

function loadData(){
  var btn=document.getElementById('refbtn');btn.style.opacity='0.35';
  fetch(WEBHOOK)
    .then(r=>r.json())
    .then(j=>{
      rawB=j.budget;rawA=j.activity;rawS=j.snapshot;
      lastUp=new Date();parsed=parseAll();renderCur();
      try{localStorage.setItem('tala_v1',JSON.stringify({b:rawB,a:rawA,s:rawS,ts:lastUp.toISOString()}))}catch(e){}
    })
    .catch(e=>showErr(e.message))
    .finally(()=>{btn.style.opacity=''});
}
function showErr(msg){
  var h='<div class="sc"><div class="etitle">Load failed</div><div class="stext">'+msg+'</div><button class="btn-retry" onclick="loadData()">Retry</button></div>';
  document.getElementById('hc').innerHTML=h;
}

function parseAll(){
  var vm=viewMonth.getMonth(),vy=viewMonth.getFullYear();
  var bData=rawB.slice(1);var aData=rawA.slice(1);var sData=rawS.slice(1);
  
  var bRows=bData.filter(r=>{var d=parseDate(r[5]);return d&&d.getMonth()===vm&&d.getFullYear()===vy});
  
  var categories=bRows.map(r=>({
    cat:String(r[7]).trim(),
    group:String(r[6]).trim(),
    totalAssigned:pn(r[11]),
    activity:pn(r[12]),
    available:pn(r[14])
  })).filter(c=>c.cat);
  
  var rta=0;
  for(var i=0;i<sData.length;i++){
    var sd=parseDate(sData[i][0]);
    if(sd&&sd.getMonth()===vm&&sd.getFullYear()===vy){
      rta=pn(sData[i][6]);break;
    }
  }
  
  var monthAct=aData.filter(r=>{var d=parseDate(r[0]);return d&&d.getMonth()===vm&&d.getFullYear()===vy});
  var expRows=monthAct.filter(r=>String(r[1]).trim()==='Expense');
  var incRows=monthAct.filter(r=>String(r[1]).trim()==='Income');
  
  var totalInc=incRows.reduce((s,r)=>s+Math.abs(pn(r[2])),0);
  var totalExp=expRows.reduce((s,r)=>s+Math.abs(pn(r[2])),0);
  var totalAssignedAll=bRows.reduce((s,r)=>s+pn(r[11]),0);
  
  return {categories,readyToAssign:rta,totalInc,totalExp,totalAssignedAll};
}

function renderHome(){
  var p=parsed;
  document.getElementById('hc').innerHTML=
    '<div class="hero"><div class="hglow pos"></div><div class="hi">'+
    '<div class="hmlbl">Left to Assign</div>'+
    '<div class="hamt pos">'+peso(p.readyToAssign)+'</div>'+
    '</div></div>'+
    '<div class="ts">Working! Data loaded successfully.</div>';
}

function renderPlan(){document.getElementById('pc').innerHTML='<div class="ts">Plan tab - '+parsed.categories.length+' categories</div>'}
function renderSpend(){document.getElementById('sc2').innerHTML='<div class="ts">Spend tab ready</div>'}
function renderAccounts(){document.getElementById('ac').innerHTML='<div class="ts">Accounts tab ready</div>'}
function renderGoals(){document.getElementById('gc').innerHTML='<div class="ts">Goals tab ready</div>'}
function renderReports(){document.getElementById('rc').innerHTML='<div class="ts">Reports tab ready</div>'}

setML();loadData();
</script>
</body>
</html>
